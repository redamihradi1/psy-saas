{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-5xl">
  <!-- Header -->
  <div class="mb-6">
    <a href="{% url 'tests_psy:beck_liste' %}" class="text-primary hover:text-primary-dark mb-4 inline-block">
      <i class="fas fa-arrow-left mr-2"></i>Retour à la liste
    </a>
    <h1 class="text-3xl font-bold text-gray-900">{{ title }}</h1>
    <p class="text-gray-600 mt-2">Inventaire de dépression de Beck (BDI-II)</p>
  </div>

  <!-- Patient info -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex items-center">
      <div class="flex-shrink-0 h-16 w-16 bg-primary-light rounded-full flex items-center justify-center">
        <span class="text-primary font-bold text-xl">{{ patient.prenom.0 }}{{ patient.nom.0 }}</span>
      </div>
      <div class="ml-4">
        <h2 class="text-xl font-semibold text-gray-900">{{ patient.nom_complet }}</h2>
        <p class="text-gray-600">{{ patient.age }} ans • Né(e) le {{ patient.date_naissance|date:"d/m/Y" }}</p>
      </div>
    </div>
  </div>

  <!-- Instructions -->
  <div class="bg-blue-50 border-l-4 border-blue-400 p-6 mb-6">
    <h3 class="font-semibold text-blue-900 mb-2">
      <i class="fas fa-info-circle mr-2"></i>Instructions
    </h3>
    <p class="text-blue-800 text-sm">
      Ce questionnaire contient 21 groupes de phrases. Pour chacun des groupes :
    </p>
    <ol class="list-decimal list-inside text-blue-800 text-sm mt-2 space-y-1">
      <li>Lisez attentivement toutes les phrases</li>
      <li>Cochez la ou les phrases qui décrivent le mieux comment vous vous sentez <strong>depuis une semaine et dans le moment présent</strong></li>
      <li>Si plusieurs phrases vous conviennent, vous pouvez en cocher plusieurs</li>
    </ol>
  </div>

  <!-- Formulaire de passation -->
  <form method="post" id="beckForm">
    {% csrf_token %}

    <div class="space-y-6">
      {% for item in items %}
      <div class="bg-white rounded-lg shadow-md p-6">
        <!-- Titre de l'item -->
        <div class="mb-4 pb-3 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            {{ item.numero }}. {{ item.categorie }}
          </h3>
        </div>

        <!-- Phrases à cocher -->
        <div class="space-y-3">
          {% for phrase in item.phrases.all %}
          <label class="flex items-start p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition">
            <input
              type="checkbox"
              name="item_{{ item.numero }}"
              value="{{ phrase.id }}"
              data-score="{{ phrase.score_valeur }}"
              data-item="{{ item.numero }}"
              class="mt-1 rounded border-gray-300 text-primary focus:ring-primary"
              {% if phrase.id in reponses_existantes|get_item:item.numero %}checked{% endif %}
            >
            <span class="ml-3 text-gray-700">
              <span class="inline-block w-8 text-primary font-semibold">{{ phrase.score_valeur }}</span>
              {{ phrase.texte }}
            </span>
          </label>
          {% endfor %}
        </div>

        <!-- Indicateur de sélection -->
        <div class="mt-4 pt-3 border-t border-gray-200">
          <p class="text-sm text-gray-500">
            Score sélectionné : <span class="font-semibold text-primary" id="score_item_{{ item.numero }}">0</span>
          </p>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Boutons de soumission -->
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-sm text-gray-600">Progression</p>
          <p class="text-lg font-semibold text-gray-900">
            <span id="items_completed">0</span> / 21 items complétés
          </p>
        </div>
        <div class="flex space-x-4">
          <a href="{% url 'tests_psy:beck_liste' %}" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
            Annuler
          </a>
          <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white font-semibold rounded-lg transition shadow-md">
            <i class="fas fa-check mr-2"></i>Terminer le test
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('beckForm');
  const checkboxes = form.querySelectorAll('input[type="checkbox"]');

  // Fonction pour calculer le score max d'un item
  function updateItemScore(itemNumber) {
    const itemCheckboxes = form.querySelectorAll(`input[data-item="${itemNumber}"]:checked`);
    let maxScore = 0;

    itemCheckboxes.forEach(checkbox => {
      const score = parseInt(checkbox.dataset.score);
      if (score > maxScore) {
        maxScore = score;
      }
    });

    const scoreDisplay = document.getElementById(`score_item_${itemNumber}`);
    if (scoreDisplay) {
      scoreDisplay.textContent = maxScore;
    }

    return maxScore > 0;
  }

  // Fonction pour mettre à jour la progression
  function updateProgress() {
    let completedItems = 0;

    for (let i = 1; i <= 21; i++) {
      if (updateItemScore(i)) {
        completedItems++;
      }
    }

    document.getElementById('items_completed').textContent = completedItems;
  }

  // Écouter les changements sur les checkboxes
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const itemNumber = this.dataset.item;
      updateItemScore(itemNumber);
      updateProgress();
    });
  });

  // Initialiser au chargement
  updateProgress();

  // Validation avant soumission
  form.addEventListener('submit', function(e) {
    const completedItems = parseInt(document.getElementById('items_completed').textContent);

    if (completedItems < 21) {
      e.preventDefault();
      if (!confirm(`Attention ! Seulement ${completedItems}/21 items sont complétés.\n\nVoulez-vous quand même soumettre le test ?`)) {
        return false;
      }
    }
  });
});
</script>

{% endblock %}
