{% extends 'base.html' %}

{% block title %}Comparaisons par Paires - Vineland{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-lg p-8">
    <!-- En-tête -->
    <div class="mb-6 pb-6 border-b border-gray-200">
        <div class="flex justify-between items-start">
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-exchange-alt text-primary mr-2"></i>
                    Comparaisons par Paires - Vineland-II
                </h2>
                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                    <div>
                        <i class="fas fa-user mr-1"></i>
                        <strong>Patient :</strong> {{ patient.nom_complet }}
                    </div>
                    <div>
                        <i class="fas fa-birthday-cake mr-1"></i>
                        <strong>Né(e) le :</strong> {{ patient.date_naissance|date:"d/m/Y" }}
                    </div>
                    <div>
                        <i class="fas fa-calendar mr-1"></i>
                        <strong>Date du test :</strong> {{ test.date_passation|date:"d/m/Y" }}
                    </div>
                    <div>
                        <i class="fas fa-hourglass-half mr-1"></i>
                        <strong>Âge au test :</strong> {{ age.years }} ans, {{ age.months }} mois, {{ age.days }} jours
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sélecteur de niveau de significativité -->
    <div class="mb-6 bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
        <form method="get" class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-3">
                <i class="fas fa-sliders-h text-primary text-xl"></i>
                <label class="font-semibold text-gray-700">
                    Niveau de significativité :
                </label>
                <div class="flex gap-2">
                    <label class="relative">
                        <input type="radio" 
                               name="niveau_significativite" 
                               value=".05"
                               {% if niveau_significativite == '.05' %}checked{% endif %}
                               class="peer sr-only">
                        <div class="px-5 py-2 border-2 border-gray-300 rounded-lg cursor-pointer 
                                    peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white
                                    hover:border-primary transition font-semibold">
                            .05
                        </div>
                    </label>
                    <label class="relative">
                        <input type="radio" 
                               name="niveau_significativite" 
                               value=".01"
                               {% if niveau_significativite == '.01' %}checked{% endif %}
                               class="peer sr-only">
                        <div class="px-5 py-2 border-2 border-gray-300 rounded-lg cursor-pointer 
                                    peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white
                                    hover:border-primary transition font-semibold">
                            .01
                        </div>
                    </label>
                </div>
            </div>
            <button type="submit" 
                    class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg font-semibold transition shadow-md flex items-center justify-center">
                <i class="fas fa-sync-alt mr-2"></i>Appliquer
            </button>
        </form>
    </div>

    <!-- Info Box -->
    <div class="mb-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 text-xl mr-3 mt-0.5"></i>
            <div>
                <h3 class="font-semibold text-blue-900 mb-1">À propos des comparaisons par paires</h3>
                <p class="text-sm text-blue-800">
                    Ces comparaisons permettent d'identifier les points forts et faibles relatifs du patient 
                    en comparant les scores entre domaines et entre sous-domaines. 
                    Une différence <strong>significative</strong> (✓) indique que l'écart observé est statistiquement fiable. 
                    La <strong>fréquence</strong> indique à quelle point cette différence est rare dans la population.
                </p>
            </div>
        </div>
    </div>

    <!-- Navigation rapide -->
    <div class="mb-6 flex flex-wrap gap-2">
        <a href="#domaines" 
           class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary-dark transition">
            <i class="fas fa-layer-group mr-1"></i>Domaines
        </a>
        <a href="#sous-domaines" 
           class="px-4 py-2 bg-gray-100 hover:bg-primary hover:text-white rounded-lg text-sm font-medium transition">
            <i class="fas fa-puzzle-piece mr-1"></i>Sous-domaines
        </a>
        <a href="#inter-domaines" 
           class="px-4 py-2 bg-gray-100 hover:bg-primary hover:text-white rounded-lg text-sm font-medium transition">
            <i class="fas fa-exchange-alt mr-1"></i>Inter-domaines
        </a>
    </div>

    <!-- Comparaisons des domaines -->
    <div id="domaines" class="mb-10 scroll-mt-20">
        <div class="bg-gradient-to-r from-primary to-primary-dark rounded-lg p-4 mb-4 shadow-lg">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-layer-group mr-2"></i>
                Comparaisons des domaines
            </h2>
        </div>

        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                    <tr>
                        <th class="border border-gray-300 px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Domaine 1
                        </th>
                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Note standard
                        </th>
                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-300">
                            &lt;, >, ou =
                        </th>
                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Note standard
                        </th>
                        <th class="border border-gray-300 px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Domaine 2
                        </th>
                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Différence
                        </th>
                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Significativité<br />(.05 ou .01)
                        </th>
                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Fréquence<br />(16, 10, 5%)
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for comparison in domain_comparisons %}
                    <tr class="hover:bg-blue-50 transition">
                        <td class="border border-gray-300 px-4 py-3 font-semibold text-gray-900">
                            {{ comparison.domaine1 }}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center text-lg font-bold text-primary">
                            {{ comparison.note1 }}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center bg-gray-100">
                            <span class="text-2xl font-bold 
                                         {% if comparison.signe == '>' %}text-green-600
                                         {% elif comparison.signe == '<' %}text-red-600
                                         {% else %}text-gray-600{% endif %}">
                                {{ comparison.signe }}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center text-lg font-bold text-primary">
                            {{ comparison.note2 }}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 font-semibold text-gray-900">
                            {{ comparison.domaine2 }}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-bold
                                         {% if comparison.difference > 15 %}bg-red-100 text-red-800
                                         {% elif comparison.difference > 10 %}bg-orange-100 text-orange-800
                                         {% elif comparison.difference > 5 %}bg-yellow-100 text-yellow-800
                                         {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ comparison.difference }}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            {% if comparison.est_significatif %}
                                <span class="inline-flex items-center justify-center w-8 h-8 bg-green-100 rounded-full">
                                    <i class="fas fa-check text-green-600 text-xl font-bold"></i>
                                </span>
                            {% else %}
                                <span class="text-gray-400 text-2xl">-</span>
                            {% endif %}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            {% if comparison.frequence %}
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-bold
                                             {% if comparison.frequence == '< 5' %}bg-purple-100 text-purple-800
                                             {% elif comparison.frequence == '5-10' %}bg-blue-100 text-blue-800
                                             {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ comparison.frequence }}%
                                </span>
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Comparaisons des sous-domaines par domaine -->
    <div id="sous-domaines" class="mb-10 scroll-mt-20">
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 mb-4 shadow-lg">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-puzzle-piece mr-2"></i>
                Comparaisons des sous-domaines (intra-domaines)
            </h2>
        </div>

        {% for domaine, comparisons in sous_domaine_comparisons.items %}
        <div class="mb-6">
            <h3 class="font-bold text-gray-900 mb-3 bg-green-100 p-3 rounded-lg border-l-4 border-green-500 flex items-center">
                <i class="fas fa-folder mr-2 text-green-600"></i>
                {{ domaine }}
            </h3>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                        <tr>
                            <th class="border border-gray-300 px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase">
                                Sous-domaine 1
                            </th>
                            <th class="border border-gray-300 px-4 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                                Note échelle-v
                            </th>
                            <th class="border border-gray-300 px-4 py-2 text-center text-xs font-bold text-gray-700 uppercase bg-gray-300">
                                &lt;, >, ou =
                            </th>
                            <th class="border border-gray-300 px-4 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                                Note échelle-v
                            </th>
                            <th class="border border-gray-300 px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase">
                                Sous-domaine 2
                            </th>
                            <th class="border border-gray-300 px-4 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                                Différence
                            </th>
                            <th class="border border-gray-300 px-4 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                                Significativité<br />(.05 ou .01)
                            </th>
                            <th class="border border-gray-300 px-4 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                                Fréquence<br />(16, 10, 5%)
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for comparison in comparisons %}
                        <tr class="hover:bg-green-50 transition">
                            <td class="border border-gray-300 px-4 py-2 font-medium text-gray-900">
                                {{ comparison.sous_domaine1 }}
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-center text-lg font-bold text-primary">
                                {{ comparison.note1 }}
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-center bg-gray-100">
                                <span class="text-2xl font-bold 
                                             {% if comparison.signe == '>' %}text-green-600
                                             {% elif comparison.signe == '<' %}text-red-600
                                             {% else %}text-gray-600{% endif %}">
                                    {{ comparison.signe }}
                                </span>
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-center text-lg font-bold text-primary">
                                {{ comparison.note2 }}
                            </td>
                            <td class="border border-gray-300 px-4 py-2 font-medium text-gray-900">
                                {{ comparison.sous_domaine2 }}
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-center">
                                <span class="inline-block px-3 py-1 rounded-full text-sm font-bold
                                             {% if comparison.difference > 6 %}bg-red-100 text-red-800
                                             {% elif comparison.difference > 4 %}bg-orange-100 text-orange-800
                                             {% elif comparison.difference > 2 %}bg-yellow-100 text-yellow-800
                                             {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ comparison.difference }}
                                </span>
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-center">
                                {% if comparison.est_significatif %}
                                    <span class="inline-flex items-center justify-center w-8 h-8 bg-green-100 rounded-full">
                                        <i class="fas fa-check text-green-600 text-xl font-bold"></i>
                                    </span>
                                {% else %}
                                    <span class="text-gray-400 text-2xl">-</span>
                                {% endif %}
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-center">
                                {% if comparison.frequence %}
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-bold
                                                 {% if comparison.frequence == '< 5' %}bg-purple-100 text-purple-800
                                                 {% elif comparison.frequence == '5-10' %}bg-blue-100 text-blue-800
                                                 {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ comparison.frequence }}%
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Comparaisons des sous-domaines inter-domaines -->
    <div id="inter-domaines" class="mb-10 scroll-mt-20">
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 mb-4 shadow-lg">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-exchange-alt mr-2"></i>
                Comparaisons des sous-domaines inter-domaines
            </h2>
        </div>

        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                    <tr>
                        <th class="border border-gray-300 px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">
                            Sous-domaine 1
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">
                            Domaine
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                            Note échelle-v
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase bg-gray-300">
                            &lt;, >, ou =
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                            Note échelle-v
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">
                            Sous-domaine 2
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">
                            Domaine
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                            Différence
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                            Significativité<br />(.05 ou .01)
                        </th>
                        <th class="border border-gray-300 px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase">
                            Fréquence<br />(16, 10, 5%)
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for comparison in interdomaine_comparisons %}
                    <tr class="hover:bg-purple-50 transition">
                        <td class="border border-gray-300 px-3 py-2 font-medium text-gray-900">
                            {{ comparison.sous_domaine1 }}
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-xs text-gray-600 italic">
                            {{ comparison.domaine1 }}
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-center text-lg font-bold text-primary">
                            {{ comparison.note1 }}
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-center bg-gray-100">
                            <span class="text-2xl font-bold 
                                         {% if comparison.signe == '>' %}text-green-600
                                         {% elif comparison.signe == '<' %}text-red-600
                                         {% else %}text-gray-600{% endif %}">
                                {{ comparison.signe }}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-center text-lg font-bold text-primary">
                            {{ comparison.note2 }}
                        </td>
                        <td class="border border-gray-300 px-3 py-2 font-medium text-gray-900">
                            {{ comparison.sous_domaine2 }}
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-xs text-gray-600 italic">
                            {{ comparison.domaine2 }}
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-center">
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-bold
                                         {% if comparison.difference > 6 %}bg-red-100 text-red-800
                                         {% elif comparison.difference > 4 %}bg-orange-100 text-orange-800
                                         {% elif comparison.difference > 2 %}bg-yellow-100 text-yellow-800
                                         {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ comparison.difference }}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-center">
                            {% if comparison.est_significatif %}
                                <span class="inline-flex items-center justify-center w-8 h-8 bg-green-100 rounded-full">
                                    <i class="fas fa-check text-green-600 text-xl font-bold"></i>
                                </span>
                            {% else %}
                                <span class="text-gray-400 text-2xl">-</span>
                            {% endif %}
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-center">
                            {% if comparison.frequence %}
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-bold
                                             {% if comparison.frequence == '< 5' %}bg-purple-100 text-purple-800
                                             {% elif comparison.frequence == '5-10' %}bg-blue-100 text-blue-800
                                             {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ comparison.frequence }}%
                                </span>
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Boutons de navigation -->
    <div class="flex flex-wrap gap-4 mt-8 pt-6 border-t-2 border-gray-200">
        <a href="{% url 'tests_psy:vineland_resultats' test.id %}" 
           class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold transition flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>Retour aux résultats
        </a>

        <a href="{% url 'tests_psy:vineland_pdf' test.id %}?niveau_significativite={{ niveau_significativite }}" 
           class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center shadow-lg">
            <i class="fas fa-file-pdf mr-2"></i>Télécharger le rapport PDF
        </a>

        <a href="{% url 'tests_psy:vineland_liste' %}" 
           class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg font-semibold transition flex items-center shadow-lg">
            <i class="fas fa-list mr-2"></i>Retour à la liste
        </a>
    </div>
</div>

<!-- Légende d'interprétation -->
<div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
        <div class="flex items-start">
            <i class="fas fa-check-circle text-green-600 text-2xl mr-3 mt-0.5"></i>
            <div>
                <h3 class="font-bold text-green-900 mb-1">Significativité</h3>
                <p class="text-sm text-green-800">
                    Une coche (✓) indique que la différence est <strong>statistiquement significative</strong> 
                    au niveau choisi (.05 ou .01). Cela signifie que l'écart n'est probablement pas dû au hasard.
                </p>
            </div>
        </div>
    </div>

    <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
        <div class="flex items-start">
            <i class="fas fa-percentage text-purple-600 text-2xl mr-3 mt-0.5"></i>
            <div>
                <h3 class="font-bold text-purple-900 mb-1">Fréquence</h3>
                <p class="text-sm text-purple-800">
                    Indique le pourcentage de la population qui présente une différence aussi importante. 
                    Plus le pourcentage est faible (&lt; 5%), plus la différence est rare et remarquable.
                </p>
            </div>
        </div>
    </div>

    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <div class="flex items-start">
            <i class="fas fa-arrows-alt-h text-blue-600 text-2xl mr-3 mt-0.5"></i>
            <div>
                <h3 class="font-bold text-blue-900 mb-1">Interprétation</h3>
                <p class="text-sm text-blue-800">
                    <strong>&gt;</strong> = Force relative<br>
                    <strong>&lt;</strong> = Faiblesse relative<br>
                    <strong>=</strong> = Pas de différence notable
                </p>
            </div>
        </div>
    </div>
</div>

<style>
/* Animation au scroll */
html {
    scroll-behavior: smooth;
}

/* Animation pour les lignes du tableau au hover */
tbody tr {
    transition: all 0.2s ease;
}

tbody tr:hover {
    transform: scale(1.01);
}

/* Style pour les radio buttons */
input[type="radio"]:checked + div {
    transform: scale(1.05);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Animation pour les icônes de check */
@keyframes checkPop {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
}

.fa-check {
    animation: checkPop 0.3s ease;
}
</style>

{% endblock %}