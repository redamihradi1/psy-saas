{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-6 max-w-6xl">

  <!-- Header -->
  <div class="mb-6">
    <a href="{% url 'tests_psy:stai_liste' %}" class="text-primary hover:text-primary-dark mb-4 inline-flex items-center transition-colors">
      <i class="fas fa-arrow-left mr-2"></i>
      <span>Retour à la liste</span>
    </a>
    <h1 class="text-3xl font-bold text-gray-900 mt-3">{{ title }}</h1>
    <p class="text-gray-600 mt-2">
      Patient : <strong class="text-gray-900">{{ patient.nom_complet }}</strong> 
      <span class="text-gray-400 mx-2">•</span>
      <span class="text-gray-700">{{ patient.age }} ans</span>
    </p>
  </div>

  <!-- Info card -->
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-r-lg p-5 mb-8 shadow-sm">
    <div class="flex items-start">
      <div class="flex-shrink-0">
        <i class="fas fa-info-circle text-blue-500 text-2xl"></i>
      </div>
      <div class="ml-4">
        <h3 class="font-semibold text-blue-900 mb-1">Instructions</h3>
        <p class="text-sm text-blue-800 leading-relaxed">
          Ce questionnaire comporte <strong>40 items en 2 sections</strong>.
          Pour chaque item, sélectionnez le chiffre qui correspond le mieux à ce que ressent le patient.
        </p>
      </div>
    </div>
  </div>

  <!-- Formulaire -->
  <form method="post" class="space-y-8" id="stai-form">
    {% csrf_token %}

    <!-- SECTION ÉTAT (Y1) -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
      <div class="bg-gradient-to-r from-primary to-blue-600 p-6 text-white">
        <h2 class="text-2xl font-bold flex items-center">
          <i class="fas fa-thermometer-half mr-3"></i>
          SECTION ÉTAT (Y1) - Anxiété situationnelle
        </h2>
        <p class="text-blue-100 text-sm mt-2">Items 1 à 20</p>
      </div>

      <div class="bg-yellow-50 border-b border-yellow-200 p-5">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-yellow-600 text-lg mt-1 mr-3"></i>
          <div>
            <p class="font-semibold text-yellow-900 mb-2">Consigne :</p>
            <p class="text-sm text-yellow-800 leading-relaxed">
              Imaginons la situation suivante : dans quelques instants, vous allez participer à une compétition
              ou passer un concours dont le résultat est particulièrement important pour vous et la suite de votre carrière.
              Cochez le chiffre qui semble décrire le mieux ce que vous ressentez <strong>dans cette situation</strong>.
            </p>
          </div>
        </div>
      </div>

      <div class="p-6">
        <!-- En-tête des colonnes ÉTAT -->
        <div class="grid grid-cols-12 gap-4 mb-6 pb-4 border-b-2 border-gray-200">
          <div class="col-span-6 font-bold text-gray-800 text-sm flex items-center">
            En ce moment, dans cette situation :
          </div>
          <div class="col-span-6">
            <div class="grid grid-cols-4 gap-3 text-center">
              <div class="space-y-1">
                <div class="font-bold text-gray-700">1</div>
                <div class="text-xs text-gray-600 leading-tight">Pas du tout</div>
              </div>
              <div class="space-y-1">
                <div class="font-bold text-gray-700">2</div>
                <div class="text-xs text-gray-600 leading-tight">Un peu</div>
              </div>
              <div class="space-y-1">
                <div class="font-bold text-gray-700">3</div>
                <div class="text-xs text-gray-600 leading-tight">Modérément</div>
              </div>
              <div class="space-y-1">
                <div class="font-bold text-gray-700">4</div>
                <div class="text-xs text-gray-600 leading-tight">Beaucoup</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Items ÉTAT -->
        <div class="space-y-3">
          {% for item in items_etat %}
          <div class="grid grid-cols-12 gap-4 items-center p-4 rounded-lg transition-all hover:bg-gray-50 {% if item.est_inverse %}bg-blue-50 border border-blue-200{% else %}border border-transparent{% endif %}">
            <div class="col-span-6 flex items-start">
              <span class="flex-shrink-0 w-8 h-8 rounded-full bg-primary text-white font-bold text-sm flex items-center justify-center mr-3 shadow-sm">
                {{ item.numero }}
              </span>
              <span class="text-gray-900 leading-relaxed pt-1">{{ item.texte }}</span>
            </div>
            <div class="col-span-6">
              <div class="grid grid-cols-4 gap-3">
                {% for valeur in "1234" %}
                <div class="flex justify-center">
                  <input 
                    type="radio" 
                    name="item_{{ item.numero }}" 
                    value="{{ valeur }}" 
                    id="item_{{ item.numero }}_{{ valeur }}"
                    class="hidden peer stai-radio"
                    {% if reponses_existantes|get_item:item.numero == valeur|add:0 %}checked{% endif %}
                  >
                  <label 
                    for="item_{{ item.numero }}_{{ valeur }}"
                    class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-300 bg-white cursor-pointer transition-all hover:border-primary hover:shadow-md peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white peer-checked:shadow-lg peer-checked:scale-105 font-bold text-lg text-gray-700"
                  >
                    {{ valeur }}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- SECTION TRAIT (Y2) -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
      <div class="bg-gradient-to-r from-green-600 to-teal-600 p-6 text-white">
        <h2 class="text-2xl font-bold flex items-center">
          <i class="fas fa-user-check mr-3"></i>
          SECTION TRAIT (Y2) - Anxiété générale
        </h2>
        <p class="text-green-100 text-sm mt-2">Items 21 à 40</p>
      </div>

      <div class="bg-yellow-50 border-b border-yellow-200 p-5">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-yellow-600 text-lg mt-1 mr-3"></i>
          <div>
            <p class="font-semibold text-yellow-900 mb-2">Consigne :</p>
            <p class="text-sm text-yellow-800 leading-relaxed">
              Cochez le chiffre approprié qui convient le mieux à la façon dont vous vous sentez
              <strong>en général, dans votre quotidien</strong>.
            </p>
          </div>
        </div>
      </div>

      <div class="p-6">
        <!-- En-tête des colonnes TRAIT -->
        <div class="grid grid-cols-12 gap-4 mb-6 pb-4 border-b-2 border-gray-200">
          <div class="col-span-6 font-bold text-gray-800 text-sm flex items-center">
            En général, dans mon quotidien :
          </div>
          <div class="col-span-6">
            <div class="grid grid-cols-4 gap-3 text-center">
              <div class="space-y-1">
                <div class="font-bold text-gray-700">1</div>
                <div class="text-xs text-gray-600 leading-tight">Presque jamais</div>
              </div>
              <div class="space-y-1">
                <div class="font-bold text-gray-700">2</div>
                <div class="text-xs text-gray-600 leading-tight">Parfois</div>
              </div>
              <div class="space-y-1">
                <div class="font-bold text-gray-700">3</div>
                <div class="text-xs text-gray-600 leading-tight">Souvent</div>
              </div>
              <div class="space-y-1">
                <div class="font-bold text-gray-700">4</div>
                <div class="text-xs text-gray-600 leading-tight">Presque toujours</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Items TRAIT -->
        <div class="space-y-3">
          {% for item in items_trait %}
          <div class="grid grid-cols-12 gap-4 items-center p-4 rounded-lg transition-all hover:bg-gray-50 {% if item.est_inverse %}bg-blue-50 border border-blue-200{% else %}border border-transparent{% endif %}">
            <div class="col-span-6 flex items-start">
              <span class="flex-shrink-0 w-8 h-8 rounded-full bg-green-600 text-white font-bold text-sm flex items-center justify-center mr-3 shadow-sm">
                {{ item.numero }}
              </span>
              <span class="text-gray-900 leading-relaxed pt-1">{{ item.texte }}</span>
            </div>
            <div class="col-span-6">
              <div class="grid grid-cols-4 gap-3">
                {% for valeur in "1234" %}
                <div class="flex justify-center">
                  <input 
                    type="radio" 
                    name="item_{{ item.numero }}" 
                    value="{{ valeur }}" 
                    id="item_{{ item.numero }}_{{ valeur }}"
                    class="hidden peer stai-radio"
                    {% if reponses_existantes|get_item:item.numero == valeur|add:0 %}checked{% endif %}
                  >
                  <label 
                    for="item_{{ item.numero }}_{{ valeur }}"
                    class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-300 bg-white cursor-pointer transition-all hover:border-green-600 hover:shadow-md peer-checked:bg-green-600 peer-checked:border-green-600 peer-checked:text-white peer-checked:shadow-lg peer-checked:scale-105 font-bold text-lg text-gray-700"
                  >
                    {{ valeur }}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Barre de progression -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <span class="text-sm font-semibold text-gray-700">Progression</span>
        <span class="text-sm font-bold text-primary" id="progress-text">0/40 items</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
        <div id="progress-bar" class="bg-gradient-to-r from-primary to-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Boutons de soumission -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <a href="{% url 'tests_psy:stai_liste' %}" class="w-full sm:w-auto px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 hover:border-gray-400 transition-all inline-flex items-center justify-center">
          <i class="fas fa-times mr-2"></i>
          <span>Annuler</span>
        </a>
        <button type="submit" id="submit-btn" class="w-full sm:w-auto px-8 py-3 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl transform hover:scale-105 inline-flex items-center justify-center">
          <i class="fas fa-check-circle mr-2"></i>
          <span>Terminer et voir les résultats</span>
        </button>
      </div>
    </div>

  </form>

</div>

<script>
(function() {
  
  const form = document.getElementById('stai-form');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const submitBtn = document.getElementById('submit-btn');
  const totalItems = 40;

  if (!form || !progressBar || !progressText) {
    return;
  }

  function updateProgress() {
    let answeredCount = 0;
    
    for (let i = 1; i <= totalItems; i++) {
      const radios = document.querySelectorAll('input[name="item_' + i + '"]');
      for (let radio of radios) {
        if (radio.checked) {
          answeredCount++;
          break;
        }
      }
    }
    
    const percentage = (answeredCount / totalItems) * 100;
    progressBar.style.width = percentage + '%';
    progressText.textContent = answeredCount + '/' + totalItems + ' items';
    
  }

  // Écouter tous les changements sur les radio buttons
  const allRadios = document.querySelectorAll('.stai-radio');
  
  allRadios.forEach(function(radio) {
    radio.addEventListener('change', function() {
      updateProgress();
    });
  });

  // Initialisation
  updateProgress();

  // Validation avant soumission
  form.addEventListener('submit', function(e) {
    
    let answeredCount = 0;
    const unansweredItems = [];
    
    for (let i = 1; i <= totalItems; i++) {
      const radios = document.querySelectorAll('input[name="item_' + i + '"]');
      let isAnswered = false;
      
      for (let radio of radios) {
        if (radio.checked) {
          isAnswered = true;
          answeredCount++;
          break;
        }
      }
      
      if (!isAnswered) {
        unansweredItems.push(i);
      }
    }
    
    if (answeredCount < totalItems) {
      e.preventDefault();
      e.stopPropagation();
      
      const missingCount = totalItems - answeredCount;
      alert('⚠️ Veuillez répondre à tous les items avant de soumettre le test.\n\n' +
            '✓ Items répondus : ' + answeredCount + '/' + totalItems + '\n' +
            '✗ Items manquants : ' + missingCount + '\n' +
            'Premier item manquant : #' + unansweredItems[0]);
      
      // Scroll vers le premier item non répondu
      const firstUnanswered = document.getElementById('item_' + unansweredItems[0] + '_1');
      if (firstUnanswered) {
        firstUnanswered.closest('.grid.grid-cols-12').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        // Highlight l'item manquant
        const container = firstUnanswered.closest('.grid.grid-cols-12');
        container.classList.add('ring-4', 'ring-red-500', 'ring-opacity-50');
        setTimeout(function() {
          container.classList.remove('ring-4', 'ring-red-500', 'ring-opacity-50');
        }, 3000);
      }
      
      return false;
    }
    
    return true;
  });
  
})();
</script>

{% endblock %}