{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-6 max-w-5xl">

  <!-- Header -->
  <div class="mb-6">
    <a href="{% url 'tests_psy:stai_liste' %}" class="text-primary hover:text-primary-dark mb-4 inline-block">
      <i class="fas fa-arrow-left mr-2"></i>Retour à la liste
    </a>
    <h1 class="text-3xl font-bold text-gray-900">{{ title }}</h1>
    <p class="text-gray-600 mt-2">Patient : <strong>{{ patient.nom_complet }}</strong> ({{ patient.age }} ans)</p>
  </div>

  <!-- Info card -->
  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="fas fa-info-circle text-blue-400 text-xl"></i>
      </div>
      <div class="ml-3">
        <p class="text-sm text-blue-700">
          <strong>Instructions :</strong> Ce questionnaire comporte 40 items en 2 sections.
          Pour chaque item, sélectionnez la réponse qui correspond le mieux à ce que ressent le patient.
        </p>
      </div>
    </div>
  </div>

  <!-- Formulaire -->
  <form method="post" class="space-y-8">
    {% csrf_token %}

    <!-- SECTION ÉTAT (Y1) -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-primary mb-2">
          <i class="fas fa-thermometer-half mr-2"></i>SECTION ÉTAT (Y1) - Anxiété situationnelle
        </h2>
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-4">
          <p class="text-sm text-yellow-700">
            <strong>Consigne :</strong> Imaginons la situation suivante : dans quelques instants, vous allez participer à une compétition
            ou passer un concours dont le résultat est particulièrement important pour vous et la suite de votre carrière.
            Cochez la case qui semble décrire le mieux ce que vous ressentez <strong>dans cette situation</strong>.
          </p>
        </div>
      </div>

      <!-- En-tête des options ÉTAT -->
      <div class="grid grid-cols-12 gap-4 mb-4 px-4 font-semibold text-sm text-gray-700">
        <div class="col-span-6">En ce moment, dans cette situation :</div>
        <div class="col-span-6 grid grid-cols-4 text-center">
          <div>Pas du tout</div>
          <div>Un peu</div>
          <div>Modérément</div>
          <div>Beaucoup</div>
        </div>
      </div>

      <!-- Items ÉTAT -->
      <div class="space-y-3">
        {% for item in items_etat %}
        <div class="grid grid-cols-12 gap-4 items-center p-4 hover:bg-gray-50 rounded-lg transition {% if item.est_inverse %}bg-blue-50{% endif %}">
          <div class="col-span-6 flex items-start">
            <span class="font-semibold text-primary mr-3">{{ item.numero }}.</span>
            <span class="text-gray-900">{{ item.texte }}</span>
          </div>
          <div class="col-span-6 grid grid-cols-4 gap-2">
            {% for valeur in "1234" %}
            <div class="flex justify-center">
              <input
                type="radio"
                name="item_{{ item.numero }}"
                value="{{ valeur }}"
                id="item_{{ item.numero }}_{{ valeur }}"
                class="w-5 h-5 text-primary focus:ring-primary"
                {% if reponses_existantes|get_item:item.numero == valeur|add:0 %}checked{% endif %}
                required
              >
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- SECTION TRAIT (Y2) -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-primary mb-2">
          <i class="fas fa-user-check mr-2"></i>SECTION TRAIT (Y2) - Anxiété générale
        </h2>
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-4">
          <p class="text-sm text-yellow-700">
            <strong>Consigne :</strong> Cochez la case appropriée qui convient le mieux à la façon dont vous vous sentez
            <strong>en général, dans votre quotidien</strong>.
          </p>
        </div>
      </div>

      <!-- En-tête des options TRAIT -->
      <div class="grid grid-cols-12 gap-4 mb-4 px-4 font-semibold text-sm text-gray-700">
        <div class="col-span-6">En général, dans mon quotidien :</div>
        <div class="col-span-6 grid grid-cols-4 text-center">
          <div>Presque jamais</div>
          <div>Parfois</div>
          <div>Souvent</div>
          <div>Presque toujours</div>
        </div>
      </div>

      <!-- Items TRAIT -->
      <div class="space-y-3">
        {% for item in items_trait %}
        <div class="grid grid-cols-12 gap-4 items-center p-4 hover:bg-gray-50 rounded-lg transition {% if item.est_inverse %}bg-blue-50{% endif %}">
          <div class="col-span-6 flex items-start">
            <span class="font-semibold text-primary mr-3">{{ item.numero }}.</span>
            <span class="text-gray-900">{{ item.texte }}</span>
          </div>
          <div class="col-span-6 grid grid-cols-4 gap-2">
            {% for valeur in "1234" %}
            <div class="flex justify-center">
              <input
                type="radio"
                name="item_{{ item.numero }}"
                value="{{ valeur }}"
                id="item_{{ item.numero }}_{{ valeur }}"
                class="w-5 h-5 text-primary focus:ring-primary"
                {% if reponses_existantes|get_item:item.numero == valeur|add:0 %}checked{% endif %}
                required
              >
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Boutons de soumission -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center">
        <a href="{% url 'tests_psy:stai_liste' %}" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
          <i class="fas fa-times mr-2"></i>Annuler
        </a>
        <button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition shadow-md">
          <i class="fas fa-check-circle mr-2"></i>Terminer et voir les résultats
        </button>
      </div>
    </div>

  </form>

</div>

<script>
// Validation avant soumission
document.querySelector('form').addEventListener('submit', function(e) {
  const totalItems = {{ items_etat|length|add:items_trait|length }};
  let answeredCount = 0;

  for (let i = 1; i <= totalItems; i++) {
    const radios = document.getElementsByName('item_' + i);
    for (let radio of radios) {
      if (radio.checked) {
        answeredCount++;
        break;
      }
    }
  }

  if (answeredCount < totalItems) {
    e.preventDefault();
    alert('Veuillez répondre à tous les items avant de soumettre le test. Items répondus : ' + answeredCount + '/' + totalItems);
    return false;
  }
});
</script>

{% endblock %}
