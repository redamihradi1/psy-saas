{% extends 'base.html' %}

{% block title %}Ajouter un fichier - {{ patient.nom_complet }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <a href="{% url 'cabinet:patient_detail' patient.id %}" class="text-primary hover:text-primary-dark mb-4 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Retour au patient
        </a>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-file-upload text-primary mr-2"></i>
            Ajouter un fichier
        </h1>
        <p class="text-gray-600">Pour {{ patient.nom_complet }}</p>
    </div>

    <!-- Formulaire -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}

            <!-- Zone de drag & drop -->
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-primary transition cursor-pointer mb-6">
                <i class="fas fa-cloud-upload-alt text-6xl text-gray-300 mb-4"></i>
                <p class="text-lg text-gray-600 mb-2">Glissez-déposez un fichier ici</p>
                <p class="text-sm text-gray-500 mb-4">ou</p>
                <label for="{{ form.fichier.id_for_label }}" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg cursor-pointer inline-block transition">
                    <i class="fas fa-folder-open mr-2"></i>Parcourir les fichiers
                </label>
                {{ form.fichier }}
                <p class="text-xs text-gray-500 mt-4">
                    Formats acceptés : PDF, Word, Excel, PowerPoint, Images (JPG, PNG, GIF)<br>
                    Taille maximale : 10 MB
                </p>
            </div>

            <!-- Aperçu du fichier sélectionné -->
            <div id="filePreview" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i id="fileIcon" class="fas fa-file text-3xl text-gray-400 mr-4"></i>
                        <div>
                            <p id="fileName" class="font-semibold text-gray-800"></p>
                            <p id="fileSize" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <button type="button" onclick="clearFile()" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times-circle text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Nom du fichier -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-file-signature text-primary mr-1"></i>Nom du fichier
                </label>
                {{ form.nom_fichier }}
                <p class="text-xs text-gray-500 mt-1">Laissez vide pour utiliser le nom original</p>
            </div>

            <!-- Catégorie -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-tags text-primary mr-1"></i>Catégorie *
                </label>
                {{ form.categorie }}
            </div>

            <!-- Description -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-comment text-primary mr-1"></i>Description
                </label>
                {{ form.description }}
            </div>

            <!-- Boutons -->
            <div class="flex gap-4 pt-4">
                <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg">
                    <i class="fas fa-upload mr-2"></i>Uploader le fichier
                </button>
                <a href="{% url 'cabinet:patient_detail' patient.id %}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-times mr-2"></i>Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Éléments du DOM
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('{{ form.fichier.id_for_label }}');
const filePreview = document.getElementById('filePreview');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const fileIcon = document.getElementById('fileIcon');

// Drag & Drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-primary', 'bg-primary-light');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-primary', 'bg-primary-light');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-primary-light');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        showFilePreview(files[0]);
    }
});

// Changement de fichier via input
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        showFilePreview(e.target.files[0]);
    }
});

// Afficher l'aperçu du fichier
function showFilePreview(file) {
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    
    // Changer l'icône selon le type
    const ext = file.name.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
        fileIcon.className = 'fas fa-file-image text-3xl text-blue-500 mr-4';
    } else if (ext === 'pdf') {
        fileIcon.className = 'fas fa-file-pdf text-3xl text-red-500 mr-4';
    } else if (['doc', 'docx'].includes(ext)) {
        fileIcon.className = 'fas fa-file-word text-3xl text-blue-600 mr-4';
    } else if (['xls', 'xlsx'].includes(ext)) {
        fileIcon.className = 'fas fa-file-excel text-3xl text-green-600 mr-4';
    } else {
        fileIcon.className = 'fas fa-file text-3xl text-gray-400 mr-4';
    }
    
    filePreview.classList.remove('hidden');
}

// Effacer le fichier
function clearFile() {
    fileInput.value = '';
    filePreview.classList.add('hidden');
}

// Formater la taille du fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{% endblock %}